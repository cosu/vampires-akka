<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SettingsImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">ro.cosu.vampires.server.actors.settings</a> &gt; <span class="el_source">SettingsImpl.java</span></div><h1>SettingsImpl.java</h1><pre class="source lang-java linenums">/*
 *
 *  * The MIT License (MIT)
 *  * Copyright © 2016 Cosmin Dumitru, http://cosu.ro &lt;cosu@cosu.ro&gt;
 *  *
 *  * Permission is hereby granted, free of charge, to any person obtaining a copy
 *  * of this software and associated documentation files (the “Software”), to deal
 *  * in the Software without restriction, including without limitation the rights
 *  * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  * copies of the Software, and to permit persons to whom the Software is
 *  * furnished to do so, subject to the following conditions:
 *  *
 *  * The above copyright notice and this permission notice shall be included in
 *  * all copies or substantial portions of the Software.
 *  *
 *  * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *  * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  * THE SOFTWARE.
 *  *
 *
 */

package ro.cosu.vampires.server.actors.settings;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;

import com.typesafe.config.Config;
import com.typesafe.config.ConfigValueType;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Collections;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

import akka.actor.Extension;
import ro.cosu.vampires.server.resources.Resource;
import ro.cosu.vampires.server.values.User;
import ro.cosu.vampires.server.values.jobs.Job;
import ro.cosu.vampires.server.values.jobs.JobUtil;
import ro.cosu.vampires.server.values.resources.ProviderDescription;
import ro.cosu.vampires.server.values.resources.ResourceDescription;
import ro.cosu.vampires.server.writers.ResultsWriter;
import ro.cosu.vampires.server.writers.json.JsonResultsWriter;
import ro.cosu.vampires.server.writers.mongo.MongoWriter;

public class SettingsImpl implements Extension {

    public static final String SAMPLING_MODE = &quot;sampling&quot;;
    private static final String SAMPLE_SIZE = &quot;sample-size&quot;;
    private static final String EXECUTORS = &quot;executors&quot;;
    private static final String CPU_SET_SIZE = &quot;cpu-set-size&quot;;
    public static final String MODE = &quot;mode&quot;;
    private static final String JOB_DEADLINE_SECONDS = &quot;job-deadline-seconds&quot;;
    private static final String ENABLED_WRITERS = &quot;enabled-writers&quot;;
    private static final String BACKOFF_INTERVAL_SECONDS = &quot;backoff-interval-seconds&quot;;
    private static final int DEFAULT_CPU_SET_SIZE = 1;
<span class="fc" id="L67">    private static final Logger LOG = LoggerFactory.getLogger(Settings.class);</span>
    private final static int DEFAULT_MAX_JOB_DEADLINE = 60;
    private final static int DEFAULT_BACK_OFF_INTERVAL = 20;
    private final static String DEFAULT_EXECUTOR = &quot;FORK&quot;;
    private static final int JOBS_TO_SAMPLE = 30;
    public final Config vampires;


<span class="fc" id="L75">    public SettingsImpl(Config config) {</span>
<span class="fc" id="L76">        vampires = config.getConfig(&quot;vampires&quot;);</span>
<span class="fc" id="L77">    }</span>

    public List&lt;ResultsWriter&gt; getWriters() {
<span class="fc" id="L80">        List&lt;ResultsWriter&gt; writers = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L81">        List&lt;String&gt; enabledWriters = vampires.getStringList(ENABLED_WRITERS);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (enabledWriters.contains(&quot;json&quot;)) {</span>
<span class="nc" id="L83">            writers.add(new JsonResultsWriter(vampires));</span>
        }

<span class="fc bfc" id="L86" title="All 2 branches covered.">        if (enabledWriters.contains(&quot;mongo&quot;)) {</span>
<span class="fc" id="L87">            writers.add(new MongoWriter());</span>
        }

<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (writers.isEmpty()) {</span>
<span class="fc" id="L91">            LOG.warn(&quot;no writers configured!&quot;);</span>
        }

<span class="fc" id="L94">        return writers;</span>

    }

    public List&lt;Job&gt; getWorkload() {
<span class="fc" id="L99">        return JobUtil.fromConfig(vampires.getConfig(&quot;workload&quot;));</span>
    }

    public int getNumberOfJobsToSample() {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (vampires.hasPath(SAMPLE_SIZE)) {</span>
<span class="nc" id="L104">            return vampires.getInt(SAMPLE_SIZE);</span>
        } else {
<span class="nc" id="L106">            LOG.warn(&quot;Missing sampleSize config value. using default {}&quot;, JOBS_TO_SAMPLE);</span>
<span class="nc" id="L107">            return JOBS_TO_SAMPLE;</span>
        }
    }

    public List&lt;String&gt; getExecutors() {
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (vampires.hasPath(EXECUTORS)) {</span>
<span class="fc" id="L113">            return vampires.getStringList(EXECUTORS).stream().map(String::toUpperCase).collect(Collectors.toList());</span>
        } else {
<span class="fc" id="L115">            LOG.warn(&quot;Missing executors config value. using default {}&quot;, DEFAULT_EXECUTOR);</span>
<span class="fc" id="L116">            return Collections.singletonList(DEFAULT_EXECUTOR);</span>
        }

    }

    public int getBackoffInterval() {
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (vampires.hasPath(BACKOFF_INTERVAL_SECONDS)) {</span>
<span class="nc" id="L123">            return vampires.getInt(BACKOFF_INTERVAL_SECONDS);</span>
        } else {
<span class="fc" id="L125">            LOG.warn(&quot;missing &quot; + BACKOFF_INTERVAL_SECONDS + &quot; . Using default value: {}&quot;, DEFAULT_BACK_OFF_INTERVAL);</span>
        }
<span class="fc" id="L127">        return DEFAULT_BACK_OFF_INTERVAL;</span>

    }

    public int getCpuSetSize() {
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (vampires.hasPath(CPU_SET_SIZE)) {</span>
<span class="fc" id="L133">            return vampires.getInt(CPU_SET_SIZE);</span>
        } else {
<span class="fc" id="L135">            LOG.warn(&quot;missing executor &quot; + CPU_SET_SIZE + &quot; . Using default value: {}&quot;, DEFAULT_CPU_SET_SIZE);</span>
        }
<span class="fc" id="L137">        return DEFAULT_CPU_SET_SIZE;</span>
    }

    public int getJobDeadline() {

<span class="fc" id="L142">        int maxJobSeconds = DEFAULT_MAX_JOB_DEADLINE;</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (vampires.hasPath(JOB_DEADLINE_SECONDS)) {</span>
<span class="nc" id="L144">            maxJobSeconds = vampires.getInt(JOB_DEADLINE_SECONDS);</span>
        } else {
<span class="fc" id="L146">            LOG.warn(&quot;maxJobSeconds not provided. Using default value of {}&quot;, DEFAULT_MAX_JOB_DEADLINE);</span>
        }
<span class="fc" id="L148">        return maxJobSeconds;</span>
    }

    public Map&lt;Resource.ProviderType, ProviderDescription&gt; getProviders() {
<span class="fc" id="L152">        Config resourcesConfig = vampires.getConfig(&quot;resources&quot;);</span>
<span class="fc" id="L153">        return vampires.getStringList(&quot;enabled-resources&quot;).stream().map(</span>
                enabledProvider -&gt; {
<span class="fc" id="L155">                    Config providerConfig = resourcesConfig.getConfig(enabledProvider);</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                    String name = providerConfig.hasPath(&quot;name&quot;) ? providerConfig.getString(&quot;name&quot;) : enabledProvider;</span>
                    // iterate over the keys of resourcesConfig
<span class="fc" id="L158">                    Map&lt;String, ResourceDescription&gt; resourceDescriptions = resourcesConfig.getObject(enabledProvider).keySet().stream()</span>
                            // only objects are associated with providers.
                            // single values are overrides
<span class="fc" id="L161">                            .filter(key -&gt; providerConfig.getValue(key).valueType().equals(ConfigValueType.OBJECT))</span>
<span class="fc" id="L162">                            .map(key -&gt; {</span>
<span class="fc" id="L163">                                Config resourceConfig = providerConfig.getConfig(key);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">                                double cost = resourceConfig.hasPath(&quot;cost&quot;) ? resourceConfig.getDouble(&quot;cost&quot;) : 0.;</span>
<span class="fc" id="L165">                                Resource.ProviderType pt = Resource.ProviderType.valueOf(enabledProvider.toUpperCase());</span>
                                return
<span class="fc" id="L167">                                        ResourceDescription.builder().provider(pt).type(key).cost(cost).build();</span>
                            })
<span class="fc" id="L169">                            .collect(Collectors.toMap(ResourceDescription::type,Function.identity()));</span>
<span class="fc" id="L170">                    return ProviderDescription.builder()</span>
<span class="fc" id="L171">                            .description(name)</span>
<span class="fc" id="L172">                            .provider(Resource.ProviderType.valueOf(enabledProvider.toUpperCase()))</span>
<span class="fc" id="L173">                            .resourceDescriptions(ImmutableMap.copyOf(resourceDescriptions))</span>
<span class="fc" id="L174">                            .build();</span>

                }
<span class="fc" id="L177">        ).collect(Collectors.toMap(ProviderDescription::provider, Function.identity()));</span>
    }


    public User getDefaultUser() {
<span class="nc" id="L182">        return User.admin();</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>